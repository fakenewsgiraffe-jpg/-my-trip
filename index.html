<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveler's Tool - Final Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- CSS: プロ仕様のデザインをここに統合 --- */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #map { width: 100%; height: 100%; position: absolute; background: #111; z-index: 1; }
        #side-panel { position: fixed; right: 0; top: 0; width: 350px; height: 100%; background: rgba(15, 15, 15, 0.98); display: flex; flex-direction: column; transition: transform 0.4s; z-index: 1000; border-left: 1px solid #333; color: #fff; }
        #side-panel.closed { transform: translateX(350px); }
        
        /* タブ */
        .panel-tabs { display: flex; background: #000; border-bottom: 1px solid #3399ff; }
        .tab-btn { flex: 1; padding: 15px 5px; background: none; border: none; color: #666; cursor: pointer; transition: 0.3s; font-size: 12px; }
        .tab-btn.active { color: #3399ff; box-shadow: inset 0 -2px 0 #3399ff; font-weight: bold; }
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; padding: 15px; }
        .tab-content.active { display: block; }

        /* ログ・削除機能 */
        .log-item { position: relative; padding: 10px; border-bottom: 1px solid #222; }
        .delete-btn { position: absolute; right: 8px; top: 8px; font-size: 10px; color: #555; cursor: pointer; opacity: 0; transition: 0.2s; }
        .log-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #ff4444; }

        /* ボタン: 白囲い・黒文字 */
        #send-btn, .clear-btn-full, .search-btn { 
            background: #fff !important; color: #000 !important; 
            border: 1px solid #fff; font-weight: bold; padding: 10px; 
            border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px;
        }

        /* アルバム */
        #drop-zone { border: 2px dashed #3399ff; padding: 30px 10px; text-align: center; color: #3399ff; border-radius: 8px; margin-bottom: 15px; }
        #album-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .album-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; border: 1px solid #333; }

        /* 入力 */
        .dice-input-wrapper { padding: 15px; background: #000; border-top: 1px solid #333; }
        #dice-command { width: 100%; height: 50px; background: #111; border: 1px solid #333; color: #eee; padding: 8px; box-sizing: border-box; resize: none; }
        #toggle-panel { position: fixed; right: 350px; top: 10px; z-index: 1001; background: #000; color: #fff; border: 1px solid #333; padding: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="toggle-panel" onclick="togglePanel()">≫</button>

    <aside id="side-panel">
        <nav class="panel-tabs">
            <button id="tab-btn-main" class="tab-btn active" onclick="switchTab('main')">ダイスログ</button>
            <button id="tab-btn-transit" class="tab-btn" onclick="switchTab('transit')">路線図</button>
            <button id="tab-btn-album" class="tab-btn" onclick="switchTab('album')">情報</button>
        </nav>

        <div class="panel-main" style="flex-grow:1; display:flex; flex-direction:column; overflow:hidden;">
            <section id="tab-main" class="tab-content active"><div id="chat-log"></div></section>
            <section id="tab-transit" class="tab-content">
                <div id="route-res">鉄道データ同期中...</div>
                <button class="search-btn" onclick="switchTab('transit')">表示更新</button>
            </section>
            <section id="tab-album" class="tab-content">
                <div id="pos-display">地図をクリックして地点を選択</div>
                <div id="drop-zone">写真をここにドロップ</div>
                <div id="album-grid"></div>
                <button class="clear-btn-full" onclick="clearData()">全データリセット</button>
            </section>
        </div>

        <div class="dice-input-wrapper">
            <input type="text" id="user-name" value="noname" style="background:none; border:none; color:#555; outline:none;">
            <textarea id="dice-command" placeholder="Enter×2で送信&#13;1d100+10 / choice[A,B]"></textarea>
            <button id="send-btn" onclick="rollDice()">送信</button>
        </div>
    </aside>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>
    <script>
        // --- JS: 全機能をここに統合 ---
        const RAIL_COLORS = { "東海道線": "#F0862B", "伊東線": "#008803", "上野東京ライン": "#91278F", "横須賀線,総武快速線": "#007AC1", "湘南新宿ライン": "#E31F26", "京浜東北線,根岸線": "#00B2E5", "横浜線": "#80C342", "南武線,鶴見線": "#FFD400", "山手線": "#b1cb39", "中央快速線,青梅線,五日市線": "#F15A22", "中央・総武線": "#FFD400", "宇都宮線,高崎線": "#F68B1E", "埼京・川越線": "#00AC84", "JR・相鉄直通線": "#002971", "常磐快速線": "#36AE6E", "常磐緩行線": "#339999", "京葉線": "#C9252F", "武蔵野線": "#F15A22", "総武本線": "#FFD400", "成田線": "#00B261", "成田線我孫子支線": "#36AE6E", "内房線": "#00B2E5", "外房線": "#DB4028", "相模線": "#009793", "信越本線": "#00AAEE", "白新線": "#F387B7", "東北本線(東北エリア)": "#3CB371", "羽越本線": "#16C0E9", "磐越西線": "#CB7B35", "只見線": "#008DD1", "仙石線": "#00AAEE", "仙山線": "#72BC4A", "JR東海": "#ED6D00", "東海道新幹線": "#0072BA", "御殿場線": "#40743C", "飯田線": "#75A2DB", "東京メトロ": "#00A3D9", "丸ノ内線": "#F62E36", "銀座線": "#FF9500", "東西線": "#009BBF", "千代田線": "#00BB85", "副都心線": "#9C5E31", "都営地下鉄": "#199332", "大江戸線": "#CE045B", "横浜市営ブルーライン": "#0070C0", "横浜市営グリーンライン": "#00B050", "東武鉄道": "#005BAC", "スカイツリーライン": "#0F6CC3", "伊勢崎線": "#FF0000", "西武池袋線": "#FF6600", "西武新宿線": "#0099CC", "京王電鉄": "#C8006B", "京王井の頭線": "#00377E", "小田急電鉄": "#0D82C7", "東急電鉄": "#DA0442", "東急東横線": "#DA0442", "東急田園都市線": "#20A288", "京急電鉄": "#00A3E4", "相模鉄道": "#000080", "りんかい線": "#00418E", "つくばエクスプレス": "#000080", "東葉高速線": "#3FB036", "みなとみらい線": "#09357F", "多摩都市モノレール線": "#E97119", "ゆりかもめ": "#E97119" };

        let map, tiles, railLayer, stationLayer, lastPos = null;

        function init() {
            tiles = {
                light: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'),
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
            };
            map = L.map('map', { zoomControl: false }).setView([35.6812, 139.7671], 12);
            tiles.light.addTo(map);
            L.control.zoom({ position: 'topleft' }).addTo(map);

            map.on('click', e => {
                lastPos = e.latlng;
                L.popup().setLatLng(e.latlng).setContent("アルバム登録地点に設定").openOn(map);
                document.getElementById('pos-display').innerText = `選択中: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            });

            loadGeo();
            restoreState();
        }

        async function loadGeo() {
            try {
                const res = await fetch('railway.json');
                const data = await res.json();
                railLayer = L.geoJson(data, {
                    style: f => ({ color: RAIL_COLORS[f.properties.N02_003] || "#555", weight: 3, opacity: 0.8 }),
                    onEachFeature: (f, l) => l.bindPopup(`<b>${f.properties.N02_003}</b>`)
                });
                stationLayer = L.geoJson(data, {
                    pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 3, color: "#fff", weight: 1, fillOpacity: 0.8 }),
                    onEachFeature: (f, l) => l.bindPopup(`駅名: ${f.properties.N02_005}`)
                });
                document.getElementById('route-res').innerText = "鉄道データ同期完了";
            } catch (e) { document.getElementById('route-res').innerText = "データ読み込み待ち..."; }
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.getElementById(`tab-btn-${id}`).classList.add('active');
            if (id === 'transit') {
                map.removeLayer(tiles.light); tiles.dark.addTo(map);
                if (railLayer) railLayer.addTo(map);
                if (stationLayer) stationLayer.addTo(map);
            } else {
                map.removeLayer(tiles.dark); tiles.light.addTo(map);
                if (railLayer) map.removeLayer(railLayer);
                if (stationLayer) map.removeLayer(stationLayer);
            }
        };

        window.rollDice = () => {
            const name = document.getElementById('user-name').value || "noname";
            const cmdInput = document.getElementById('dice-command');
            let txt = cmdInput.value.trim();
            if (!txt) return;

            const dm = txt.match(/^(\d+)d(\d+)([\+\-]\d+)?$/i);
            const cm = txt.match(/choice\[(.*?)\]/);

            if (dm) {
                let n = parseInt(dm[1]), side = parseInt(dm[2]), mod = dm[3] ? parseInt(dm[3]) : 0;
                let rolls = [];
                for(let i=0; i<n; i++) rolls.push(Math.floor(Math.random()*side)+1);
                let sum = rolls.reduce((a,b)=>a+b, 0);
                txt = `${txt} (${rolls.join(',')})${mod!==0?(mod>0?'+'+mod:mod):''} ➔ <b>${sum + mod}</b>`;
            } else if (cm) {
                const list = cm[1].split(',');
                txt = `${txt} ➔ <b>${list[Math.floor(Math.random()*list.length)].trim()}</b>`;
            }

            const id = Date.now();
            document.getElementById('chat-log').insertAdjacentHTML('beforeend', `
                <div class="log-item" id="log-${id}">
                    <span class="delete-btn" onclick="document.getElementById('log-${id}').remove(); save();">削除</span>
                    <div style="font-size:10px; color:#3399ff;">${name}</div><div>${txt}</div>
                </div>`);
            cmdInput.value = "";
            save();
        };

        const dz = document.getElementById('drop-zone');
        dz.ondragover = e => { e.preventDefault(); dz.style.background = "rgba(51,153,255,0.1)"; };
        dz.ondragleave = () => dz.style.background = "none";
        dz.ondrop = e => {
            e.preventDefault();
            dz.style.background = "none";
            if(!lastPos) return alert("地図をクリックしてください");
            Array.from(e.dataTransfer.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = ev => {
                    const data = JSON.parse(localStorage.getItem('v7_album') || "[]");
                    data.push({ lat: lastPos.lat, lng: lastPos.lng, src: ev.target.result });
                    localStorage.setItem('v7_album', JSON.stringify(data));
                    renderAlbum();
                };
                reader.readAs
